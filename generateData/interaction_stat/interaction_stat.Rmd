---
title: "Pipleine to assess imputation: performance, cell mapping stability and others."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: true
    theme: united
---


# Load dependencies and source data

```{r load_data, message=FALSE}

library(Matrix)
library(scran)
library(igraph)
library(reshape2)
library(knitr)
library(scater)
library(scales)
library(biomaRt)
library(VennDiagram)
library(RColorBrewer)
library(tibble)
library(ggplot2)
library(tidyverse)
library(ggpubr)
library(viridis)
library(stringr)
library(ggridges)
library(ggpubr)
library(ggforce)
library(pROC)
library(batchelor)
library(wesanderson)
library(BiocNeighbors)
ncores = 4
mcparam = MulticoreParam(workers = ncores)
register(mcparam)

root.dir = "/nfs/research1/marioni/alsu/spatial/mouse_embryo/"
figures.dir = paste0(root.dir, "figures/imputation/imputation/heart/")
source(paste0(root.dir, "amScripts_mouseEmbryoFISH/core_functions.R"))
source(paste0(root.dir, "amScripts_mouseEmbryoFISH/visualization_functions.R"))

# load seq
load_embryo_8.5(dir = "cluster")
sce.seq = sce[!rownames(sce) == "Xist", ]
meta = data.frame(colData(sce.seq))
# add CT
meta.CT = readRDS(paste0(root.dir, "data/8_5/source/iterMNN_mapping_dt.Rds"))
meta = merge(meta, meta.CT, all.x = T, all.y = F)
CTs.2discard = c("Erythroid", "ExE endoderm", "NMP", "Presomitic mesoderm")
meta = meta[meta$iterMNN_stable_mapping_quality == "Good" & !meta$iterMNN_stable %in% CTs.2discard, ]
meta$embryo_z = paste0(meta$embryo, "_", meta$z)

# neigh.net
neigh.net = readRDS(paste0(root.dir, "data/8_5/source/E8.5_neighbourGraph_1.3.Rds"))
adjacency.list = adjacent_vertices(neigh.net, V(neigh.net), mode = "all")

```

# Get interaction stat

```{r get-stat, warning=FALSE}


interaction.stat = bplapply(meta$uniqueID, function(current.cell){
  current.adjacency.list = adjacency.list[names(adjacency.list) == current.cell]
  if (!is_empty(current.adjacency.list)){
    neighbor.cells = as_ids(current.adjacency.list[[1]])
    interaction.stat.oneCell = lapply(neighbor.cells, function(adjacent.cell){
      current.stat = data.frame(cell_1 = current.cell, cell_2 = adjacent.cell, 
                      CT_1 = meta$iterMNN_stable[meta$uniqueID == current.cell], CT_2 = meta$iterMNN_stable[meta$uniqueID == adjacent.cell], 
                      x_global_affine = (meta$x_global_affine[meta$uniqueID == current.cell] + meta$x_global_affine[meta$uniqueID == adjacent.cell])/2, 
                      y_global_affine = (meta$y_global_affine[meta$uniqueID == current.cell] + meta$y_global_affine[meta$uniqueID == adjacent.cell])/2
                      )
      return(current.stat)
    })
    interaction.stat.oneCell = do.call(rbind, interaction.stat.oneCell)
    return(interaction.stat.oneCell)
  }
  else {
    interaction.stat.oneCell = data.frame(cell_1 = current.cell, cell_2 = NA, 
                      CT_1 = meta$iterMNN_stable[meta$uniqueID == current.cell], CT_2 = NA, 
                      x_global_affine = meta$x_global_affine[meta$uniqueID == current.cell], 
                      y_global_affine = meta$y_global_affine[meta$uniqueID == current.cell]
                      )
    return(interaction.stat.oneCell)
  }
})
interaction.stat = do.call(rbind, interaction.stat)
saveRDS(interaction.stat, file = paste0( root.dir, "data/8_5/interaction_stat.rds"))  


```


#Session Info

```{r sessinf}
sessionInfo()
```
