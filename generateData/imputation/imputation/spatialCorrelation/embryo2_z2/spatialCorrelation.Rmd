---
title: "Gene score"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: true
    theme: united
---

Settings:

nn = 25

# Load dependencies and source data

```{r load_data, message=FALSE}

library(Matrix)
library(scran)
library(BiocParallel)
library(BiocNeighbors)
ncores = 3
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
library(igraph)
library(reshape2)
library(knitr)
library(scater)
library(scales)
library(biomaRt)
library(batchelor)
library(irlba)
library(batchelor)
library(tibble)
library(dplyr)
library(purrr)

#root.dir = "/Users/alsu/Develop/spatial/mouse_embryo/"
root.dir = "/nfs/research1/marioni/alsu/spatial/mouse_embryo/"
source(paste0(root.dir, "amScripts_mouseEmbryoFISH/core_functions.R"))

# load seq embryos
load_embryo_8.5(dir = "cluster")
#load_embryo_8.5(dir = "local")
sce.seq = sce[!rownames(sce) == "Xist", ]

# load atlas 
sce.atlas = readRDS(paste0(root.dir, "data/reducedAtlas/E8_25__E8_5.rds"))
sce.atlas = sce.atlas[, sce.atlas$stage == "E8.5"]

meta = data.frame( colData(sce.seq) )
meta.CT = readRDS(paste0(root.dir, "data/8_5/source/iterMNN_mapping_dt.Rds"))
meta = merge(meta, meta.CT, all.x = T, all.y = F)
meta$embryo_z = paste0(meta$embryo, "_", meta$z)
CTs.2discard = c("Erythroid", "ExE endoderm", "NMP", "Presomitic mesoderm")
meta = meta[meta$iterMNN_stable_mapping_quality == "Good" & !meta$iterMNN_stable %in% CTs.2discard & meta$embryo_z == "embryo2_2", ]
sce.seq = sce.seq[, colnames(sce.seq) %in% meta$uniqueID ]

# load mappings
imputation = readRDS(paste0( root.dir, "data/8_5/stitching/imputation/imputation_seq2atlas_logcounts_embryo2z2.rds"))
imputation = imputation[, colnames(imputation) %in% meta$uniqueID ]

# order
mapping = mapping[, order(colnames(mapping))]
sce.seq = sce.seq[,order(colnames(sce.seq))]
imputation = imputation[,order(colnames(imputation))]

genes = rownames(sce.atlas)


# neigh.net
neigh.net.within_z = readRDS(paste0(root.dir, "data/8_5/source/E8.5_neighbourGraph_1.3.Rds"))
adjacency.list.within_z = adjacent_vertices(neigh.net.within_z, V(neigh.net.within_z), mode = "all")


```

# Spatial coherence


```{r spatial-coherency-within-z, message=FALSE, warning=FALSE}


spatialCorrelation = function(n.neigh){
  spatial.imputation = bplapply(colnames(sce.seq), function(current.cell){
    current.CT = meta$iterMNN_stable[meta$uniqueID == current.cell]
    current.adjacency.list = adjacency.list.within_z[names(adjacency.list.within_z) == current.cell]
    if (!is_empty(current.adjacency.list)){
      if (n.neigh == 1){
        neighbor.cells = as_ids(current.adjacency.list[[1]])
      } else if (n.neigh == 2){
        neighbor.cells = as_ids(current.adjacency.list[[1]])
        second.neighbor.cells = sapply(neighbor.cells, function(x){
          current.second.adjacency.list = adjacency.list.within_z[names(adjacency.list.within_z) == x]
          return(as_ids(current.second.adjacency.list[[1]]))
        })
        neighbor.cells = unique(c(neighbor.cells, unlist(second.neighbor.cells)))
      }
      neighbor.CT = sapply(neighbor.cells, function(x) meta$iterMNN_stable[meta$uniqueID == x])
      cells.sameCT = c( names(neighbor.CT)[neighbor.CT == current.CT])
      cells.sameCT = setdiff(cells.sameCT, current.cell)
      if (length(cells.sameCT) > 1){
        current.spatial.imputation = apply(imputation[cells.sameCT], 1, mean)
        return(current.spatial.imputation)
      }
      else if (length(cells.sameCT) == 1){
        current.spatial.imputation = imputation[cells.sameCT]
        return(current.spatial.imputation)
      }
      else {
        current.spatial.imputation = rep(c(NA), times = length(genes))
        names(current.spatial.imputation) = genes
      }
    }
    else {
      current.spatial.imputation = rep(c(NA), times = length(genes))
      names(current.spatial.imputation) = genes
    }
    return(current.spatial.imputation)
  }, BPPARAM = mcparam)
  
  spatial.imputation = do.call(cbind, spatial.imputation)
  colnames(spatial.imputation) = colnames(sce.seq)
  
  spat.corr = bplapply(genes, function(current.gene){
    return( cor(imputation[rownames(imputation) == current.gene,], spatial.imputation[rownames(spatial.imputation) == current.gene,], method = "pearson") )
  }, BPPARAM = mcparam)
  return(spat.corr)
}
spat.corr.nn_1 = spatialCorrelation(1)
spat.corr.nn_2 = spatialCorrelation(2)
spatial.correlation = list(n.neigh_1 = spat.corr.nn_1, 
                                  n.neigh_2 = spat.corr.nn_2)
saveRDS(spatial.correlation, file =  paste0( root.dir, "data/8_5/stitching/imputation/spatialCorrelation_embryo2z2.rds"))


```



#Session Info

```{r sessinf}

sessionInfo()

```
