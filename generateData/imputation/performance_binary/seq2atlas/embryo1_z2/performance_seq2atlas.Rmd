---
title: "Mapping performance seq2atlas"
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: true
    theme: united
---

Settings:

nn = 25

# Load dependencies and source data

```{r load_data, message=FALSE}

library(Matrix)
library(scran)
library(BiocParallel)
library(BiocNeighbors)
ncores = 5
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
library(igraph)
library(reshape2)
library(knitr)
library(scater)
library(scales)
library(biomaRt)
library(batchelor)
library(irlba)
library(batchelor)
library(tibble)
library(dplyr)
library(purrr)

#root.dir = "/Users/alsu/Develop/spatial/mouse_embryo/"
root.dir = "/nfs/research1/marioni/alsu/spatial/mouse_embryo/"
source(paste0(root.dir, "amScripts_mouseEmbryoFISH/core_functions.R"))

load_embryo_8.5(dir = "cluster")
sce.seq = sce[!rownames(sce) == "Xist", ]

# load atlas 
sce.atlas = readRDS(paste0(root.dir, "data/reducedAtlas/E8_25__E8_5.rds"))
sce.atlas = sce.atlas[rownames(sce.seq), sce.atlas$stage == "E8.5"]
#counts.atlas = logcounts(sce.atlas)

# order seq and atlas (in case, cant hurt, had troubles b4)
sce.seq = sce.seq[order(rownames(sce.seq)),]
sce.atlas = sce.atlas[order(rownames(sce.atlas)),]

# load mapping
mapping = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo1z2.rds"))
sce.seq = sce.seq[, colnames(sce.seq) %in% colnames(mapping)]
#counts.seq = assay(sce.seq, "logcounts_area")
meta = data.frame( colData(sce.seq))
meta.CT = readRDS(paste0(root.dir, "data/8_5/source/E8.5_treeMNN_denoised.Rds"))
colnames(meta.CT)[colnames(meta.CT) == "cell"] <- "uniqueID"
meta = merge(meta, meta.CT, all.x = T, all.y = F)


# neigh.net
neigh.net = readRDS(paste0(root.dir, "data/8_5/source/E8.5_neighbourGraph_1.3.Rds"))

```


# Get performance stat:

1) seq-binary

2) seq-binary-denoised-1

3) seq-binary-denoised-2

4) seq-cosine

5) seq-cosine-denoised-1

6) seq-cosine-denoised-2

7) imputed-binary-mean

8) imputed-binary-mean-denoised-1

9) imputed-binary-mean-denoised-1

10) imputed-cosine-mean

11) imputed-cosine-mean-denoised-1

12) imputed-cosine-mean-denoised-2

```{r imputed-stat, message=FALSE, warning=FALSE}

mapping = mapping[, order(colnames(mapping))]
sce.seq = sce.seq[,order(colnames(sce.seq))]
genes = rownames(sce.seq)

# seq
counts.seq = counts(sce.seq)
getBinarized = function(x){
  return(as.numeric(x >= 1))  
}
# counts.binary.seq = t( apply(counts.seq, 1, function(x) getBinarized(x)) )
# rownames(counts.binary.seq) = rownames(sce.seq)
# colnames(counts.binary.seq) = colnames(sce.seq)
# counts.binary.seq.denoised_1 = denoisingBinaryCounts(counts.binary.seq, meta, neigh.net, 1, mcparam)
# counts.binary.seq.denoised_2 = denoisingBinaryCounts(counts.binary.seq, meta, neigh.net, 2, mcparam)
# 
counts.cosine.seq = as.matrix( cosineNorm(assay(sce.seq, "logcounts_area")) )
counts.cosine.seq.denoised_1 = denoisingCounts(counts.cosine.seq, meta, neigh.net, 1, "median", mcparam)
counts.cosine.seq.denoised_2 = denoisingCounts(counts.cosine.seq, meta, neigh.net, 2, "median", mcparam)

# atlas
counts.atlas = counts(sce.atlas)
# getBinarized = function(x){
#   return(as.numeric(x >= 1))  
# }
# counts.binary.atlas = t( apply(counts.atlas, 1, function(x) getBinarized(x)) )
# rownames(counts.binary.atlas) = rownames(sce.atlas)
# colnames(counts.binary.atlas) = colnames(sce.atlas)
  
counts.cosine.atlas = as.matrix( cosineNorm(assay(sce.atlas, "logcounts")) )

n.neigh = 25

# imputed-binary-mean
# counts.binary.imputed = bplapply(genes, function(current.gene){
#   current.atlas = counts.binary.atlas[rownames(counts.binary.atlas) == current.gene,]
#   current.mapping = mapping[grepl(current.gene, rownames(mapping)),]
#   mean.imputed = sapply(1:ncol(current.mapping), function(x){
#     return( mean( current.atlas[current.mapping[,x]] , na.rm = T) )
#   })
#   return(mean.imputed)
# }, BPPARAM = mcparam)
# counts.binary.imputed = do.call(rbind, counts.binary.imputed)
# colnames(counts.binary.imputed) = colnames(mapping)
# rownames(counts.binary.imputed) = genes
# 
# counts.binary.imputed.denoised_1 = denoisingCounts(counts.binary.imputed, meta, neigh.net, 1, "mean", mcparam)
# counts.binary.imputed.denoised_2 = denoisingCounts(counts.binary.imputed, meta, neigh.net, 2, "mean", mcparam)

# imputed-cosine-q60
counts.cosine.imputed.q60 = bplapply(genes, function(current.gene){
  current.atlas = counts.cosine.atlas[rownames(counts.cosine.atlas) == current.gene,]
  current.mapping = mapping[grepl(current.gene, rownames(mapping)),]
  avg.imputed = sapply(1:ncol(current.mapping), function(x){
    return( quantile( current.atlas[current.mapping[,x]] , 0.60) )
  })
  return(avg.imputed)
}, BPPARAM = mcparam)
counts.cosine.imputed.q60 = do.call(rbind, counts.cosine.imputed.q60)
colnames(counts.cosine.imputed.q60) = colnames(mapping)
rownames(counts.cosine.imputed.q60) = genes
counts.cosine.imputed.q60.denoised_1 = denoisingCounts(counts.cosine.imputed.q60, meta, neigh.net, 1, "median", mcparam)
counts.cosine.imputed.q60.denoised_2 = denoisingCounts(counts.cosine.imputed.q60, meta, neigh.net, 2, "median", mcparam)

# imputed-cosine-q70
counts.cosine.imputed.q70 = bplapply(genes, function(current.gene){
  current.atlas = counts.cosine.atlas[rownames(counts.cosine.atlas) == current.gene,]
  current.mapping = mapping[grepl(current.gene, rownames(mapping)),]
  avg.imputed = sapply(1:ncol(current.mapping), function(x){
    return( quantile( current.atlas[current.mapping[,x]] , 0.70) )
  })
  return(avg.imputed)
}, BPPARAM = mcparam)
counts.cosine.imputed.q70 = do.call(rbind, counts.cosine.imputed.q70)
colnames(counts.cosine.imputed.q70) = colnames(mapping)
rownames(counts.cosine.imputed.q70) = genes
counts.cosine.imputed.q70.denoised_1 = denoisingCounts(counts.cosine.imputed.q70, meta, neigh.net, 1, "median", mcparam)
counts.cosine.imputed.q70.denoised_2 = denoisingCounts(counts.cosine.imputed.q70, meta, neigh.net, 2, "median", mcparam)

# imputed-cosine-q80
counts.cosine.imputed.q80 = bplapply(genes, function(current.gene){
  current.atlas = counts.cosine.atlas[rownames(counts.cosine.atlas) == current.gene,]
  current.mapping = mapping[grepl(current.gene, rownames(mapping)),]
  avg.imputed = sapply(1:ncol(current.mapping), function(x){
    return( quantile( current.atlas[current.mapping[,x]] , 0.80) )
  })
  return(avg.imputed)
}, BPPARAM = mcparam)
counts.cosine.imputed.q80 = do.call(rbind, counts.cosine.imputed.q80)
colnames(counts.cosine.imputed.q80) = colnames(mapping)
rownames(counts.cosine.imputed.q80) = genes
counts.cosine.imputed.q80.denoised_1 = denoisingCounts(counts.cosine.imputed.q80, meta, neigh.net, 1, "median", mcparam)
counts.cosine.imputed.q80.denoised_2 = denoisingCounts(counts.cosine.imputed.q80, meta, neigh.net, 2, "median", mcparam)

# imputed-cosine-q90
counts.cosine.imputed.q90 = bplapply(genes, function(current.gene){
  current.atlas = counts.cosine.atlas[rownames(counts.cosine.atlas) == current.gene,]
  current.mapping = mapping[grepl(current.gene, rownames(mapping)),]
  avg.imputed = sapply(1:ncol(current.mapping), function(x){
    return( quantile( current.atlas[current.mapping[,x]] , 0.90) )
  })
  return(avg.imputed)
}, BPPARAM = mcparam)
counts.cosine.imputed.q90 = do.call(rbind, counts.cosine.imputed.q90)
colnames(counts.cosine.imputed.q90) = colnames(mapping)
rownames(counts.cosine.imputed.q90) = genes
counts.cosine.imputed.q90.denoised_1 = denoisingCounts(counts.cosine.imputed.q90, meta, neigh.net, 1, "median", mcparam)
counts.cosine.imputed.q90.denoised_2 = denoisingCounts(counts.cosine.imputed.q90, meta, neigh.net, 2, "median", mcparam)

# imputed-cosine-median
counts.cosine.imputed.median = bplapply(genes, function(current.gene){
  current.atlas = counts.cosine.atlas[rownames(counts.cosine.atlas) == current.gene,]
  current.mapping = mapping[grepl(current.gene, rownames(mapping)),]
  avg.imputed = sapply(1:ncol(current.mapping), function(x){
    return( median( current.atlas[current.mapping[,x]] , na.rm = T) )
  })
  return(avg.imputed)
}, BPPARAM = mcparam)
counts.cosine.imputed.median = do.call(rbind, counts.cosine.imputed.median)
colnames(counts.cosine.imputed.median) = colnames(mapping)
rownames(counts.cosine.imputed.median) = genes

counts.cosine.imputed.median.denoised_1 = denoisingCounts(counts.cosine.imputed.median, meta, neigh.net, 1, "median", mcparam)
counts.cosine.imputed.median.denoised_2 = denoisingCounts(counts.cosine.imputed.median, meta, neigh.net, 2, "median", mcparam)

# imputed-cosine-mean
counts.cosine.imputed.mean = bplapply(genes, function(current.gene){
  current.atlas = counts.cosine.atlas[rownames(counts.cosine.atlas) == current.gene,]
  current.mapping = mapping[grepl(current.gene, rownames(mapping)),]
  avg.imputed = sapply(1:ncol(current.mapping), function(x){
    return( mean( current.atlas[current.mapping[,x]] , na.rm = T) )
  })
  return(avg.imputed)
}, BPPARAM = mcparam)
counts.cosine.imputed.mean = do.call(rbind, counts.cosine.imputed.mean)
colnames(counts.cosine.imputed.mean) = colnames(mapping)
rownames(counts.cosine.imputed.mean) = genes
counts.cosine.imputed.mean.denoised_1 = denoisingCounts(counts.cosine.imputed.mean, meta, neigh.net, 1, "median", mcparam)
counts.cosine.imputed.mean.denoised_2 = denoisingCounts(counts.cosine.imputed.mean, meta, neigh.net, 2, "median", mcparam)

# imputed-cosine-max
counts.cosine.imputed.max = bplapply(genes, function(current.gene){
  current.atlas = counts.cosine.atlas[rownames(counts.cosine.atlas) == current.gene,]
  current.mapping = mapping[grepl(current.gene, rownames(mapping)),]
  avg.imputed = sapply(1:ncol(current.mapping), function(x){
    return( max( current.atlas[current.mapping[,x]] , na.rm = T) )
  })
  return(avg.imputed)
}, BPPARAM = mcparam)
counts.cosine.imputed.max = do.call(rbind, counts.cosine.imputed.max)
colnames(counts.cosine.imputed.max) = colnames(mapping)
rownames(counts.cosine.imputed.max) = genes
counts.cosine.imputed.max.denoised_1 = denoisingCounts(counts.cosine.imputed.max, meta, neigh.net, 1, "median", mcparam)
counts.cosine.imputed.max.denoised_2 = denoisingCounts(counts.cosine.imputed.max, meta, neigh.net, 2, "median", mcparam)

# combine together
performance.seq = list(
                       counts.cosine.seq = counts.cosine.seq,
                       counts.cosine.seq.denoised_1 = counts.cosine.seq.denoised_1,
                       counts.cosine.seq.denoised_2 = counts.cosine.seq.denoised_2,
                       counts.cosine.imputed.q60 = counts.cosine.imputed.q60,
                       counts.cosine.imputed.q60.denoised_1 = counts.cosine.imputed.q60.denoised_1,
                       counts.cosine.imputed.q60.denoised_2 = counts.cosine.imputed.q60.denoised_2,
                       counts.cosine.imputed.q70 = counts.cosine.imputed.q70,
                       counts.cosine.imputed.q70.denoised_1 = counts.cosine.imputed.q70.denoised_1,
                       counts.cosine.imputed.q70.denoised_2 = counts.cosine.imputed.q70.denoised_2,
                       counts.cosine.imputed.q80 = counts.cosine.imputed.q80,
                       counts.cosine.imputed.q80.denoised_1 = counts.cosine.imputed.q80.denoised_1,
                       counts.cosine.imputed.q80.denoised_2 = counts.cosine.imputed.q80.denoised_2,
                       counts.cosine.imputed.q80 = counts.cosine.imputed.q80,
                       counts.cosine.imputed.q80.denoised_1 = counts.cosine.imputed.q80.denoised_1,
                       counts.cosine.imputed.q80.denoised_2 = counts.cosine.imputed.q80.denoised_2,
                       counts.cosine.imputed.median = counts.cosine.imputed.median,
                       counts.cosine.imputed.median.denoised_1 = counts.cosine.imputed.median.denoised_1,
                       counts.cosine.imputed.median.denoised_2 = counts.cosine.imputed.median.denoised_2,
                       counts.cosine.imputed.mean = counts.cosine.imputed.mean,
                       counts.cosine.imputed.mean.denoised_1 = counts.cosine.imputed.mean.denoised_1,
                       counts.cosine.imputed.mean.denoised_2 = counts.cosine.imputed.mean.denoised_2,
                       counts.cosine.imputed.max = counts.cosine.imputed.max,
                       counts.cosine.imputed.max.denoised_1 = counts.cosine.imputed.max.denoised_1,
                       counts.cosine.imputed.max.denoised_2 = counts.cosine.imputed.max.denoised_2
                       )

saveRDS(performance.seq, file =  paste0( root.dir, "data/8_5/stitching/performance_binary_seq2atlas_embryo1z2.rds"))

```


#Session Info

```{r sessinf}

sessionInfo()

```
