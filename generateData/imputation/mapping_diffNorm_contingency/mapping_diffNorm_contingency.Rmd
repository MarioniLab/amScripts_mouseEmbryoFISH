---
title: "Pipleine to get contingency table between mapping using different normalizations (libsize and area) of seq-data."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: true
    theme: united
---


# Load dependencies and source data

```{r load_data, message=FALSE}

library(Matrix)
library(scran)
library(igraph)
library(reshape2)
library(knitr)
library(scater)
library(scales)
library(biomaRt)
library(VennDiagram)
library(RColorBrewer)
library(tibble)
library(ggplot2)
library(tidyverse)
library(stringr)
library(batchelor)
ncores = 3
mcparam = MulticoreParam(workers = ncores)
register(mcparam)

root.dir = "/nfs/research1/marioni/alsu/spatial/mouse_embryo/"
source(paste0(root.dir, "amScripts_mouseEmbryoFISH/core_functions.R"))
source(paste0(root.dir, "amScripts_mouseEmbryoFISH/visualization_functions.R"))

# load seq
load_embryo_8.5(dir = "cluster")
sce.seq = sce[!rownames(sce) == "Xist", ]

# get mappings
# area
mapping.embryo1z2 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo1z2.rds"))
mapping.embryo1z5 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo1z5.rds"))
mapping.embryo2z2 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo2z2.rds"))
mapping.embryo2z5 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo2z5.rds"))
mapping.embryo3z2 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo3z2.rds"))
mapping.embryo3z5 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo3z5.rds"))
mapping.area = cbind(mapping.embryo1z2, mapping.embryo1z5, mapping.embryo2z2, mapping.embryo2z5, mapping.embryo3z2, mapping.embryo3z5)
mapping.area = mapping.area[order(rownames(mapping.area)), order(colnames(mapping.area))]
  
# libsize
mapping.embryo1z2 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo1z2_libsize.rds"))
mapping.embryo1z5 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo1z5_libsize.rds"))
mapping.embryo2z2 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo2z2_libsize.rds"))
mapping.embryo2z5 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo2z5_libsize.rds"))
mapping.embryo3z2 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo3z2_libsize.rds"))
mapping.embryo3z5 = readRDS(paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_embryo3z5_libsize.rds"))
mapping.libsize = cbind(mapping.embryo1z2, mapping.embryo1z5, mapping.embryo2z2, mapping.embryo2z5, mapping.embryo3z2, mapping.embryo3z5)
mapping.libsize = mapping.libsize[order(rownames(mapping.libsize)), order(colnames(mapping.libsize))]

genes = rownames(sce.seq)

```

# Get contingency table

```{r get-stat, warning=FALSE}


n.neigh = 25
stat = bplapply(colnames(mapping.area), function(current.cell){
  mapping.area.oneCell = mapping.area[,current.cell]
  mapping.libsize.oneCell = mapping.libsize[,current.cell]
  stat.oneCell = lapply(genes, function(current.gene){
    current.mapping.area = mapping.area.oneCell[ grepl(paste0( current.gene, "_"), names(mapping.area.oneCell)) ]
    current.mapping.libsize = mapping.libsize.oneCell[ grepl(paste0( current.gene, "_"), names(mapping.libsize.oneCell)) ]
    out = data.frame(gene = current.gene,
                     contingency = length(intersect(current.mapping.area, current.mapping.libsize))/n.neigh  )
    return(out)
  })
  stat.oneCell = do.call(rbind, stat.oneCell)
  out = data.frame(uniqueID = current.cell, 
                   mean.contingency = mean(stat.oneCell$contingency),
                   sd.contingency = sd(stat.oneCell$contingency))
  return(out)
}, BPPARAM = mcparam)
stat = do.call(rbind, stat )
saveRDS(stat, file =  paste0( root.dir, "data/8_5/stitching/mapping_diffNorm_contingencyTable.rds"))

```


#Session Info

```{r sessinf}
sessionInfo()
```
