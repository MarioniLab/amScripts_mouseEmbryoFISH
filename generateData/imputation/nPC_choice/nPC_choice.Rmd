---
title: "Mapping seq2atlas - compare different nPC."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: true
    theme: united
---

Settings:

nPC = c( 25, 50, 100)

nn = 25

# Load dependencies and source data

```{r load_data, message=FALSE}

library(Matrix)
library(scran)
library(BiocParallel)
library(BiocNeighbors)
ncores = 3
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
library(igraph)
library(reshape2)
library(knitr)
library(scater)
library(scales)
library(biomaRt)
library(batchelor)
library(irlba)
library(batchelor)
library(tibble)
library(dplyr)

#root.dir = "/Users/alsu/Develop/spatial/mouse_embryo/"
root.dir = "/nfs/research1/marioni/alsu/spatial/mouse_embryo/"
source(paste0(root.dir, "amScripts_mouseEmbryoFISH/core_functions.R"))

load_embryo_8.5(dir = "cluster")
#load_embryo_8.5(dir = "local")
sce.seq = sce[!rownames(sce) == "Xist",]
sce.seq$embryo_z = paste0(sce.seq$embryo, "_", sce.seq$z)
assay(sce.seq, "cosineNorm_area") <- cosineNorm(assay(sce.seq, "logcounts_area"))

# load atlas 
sce.atlas = readRDS(paste0(root.dir, "data/reducedAtlas/E8_25__E8_5.rds"))
sce.atlas = sce.atlas[rownames(sce.seq), sce.atlas$stage == "E8.5"]
# order seq and atlas (in case, cant hurt, had troubles b4)
sce.seq = sce.seq[order(rownames(sce.seq)),]
sce.atlas = sce.atlas[order(rownames(sce.atlas)),]


n.neigh = 25
nPC.grid = c(25, 50, 75, 100)


```

# Map to atlas

## seq2atlas

```{r seq-closest-cell, message=FALSE}

embryo_z.grid = unique(sce.seq$embryo_z)
mapping = bplapply(embryo_z.grid, function(embryo_z){
  current.sce.seq = sce.seq[,sce.seq$embryo_z == embryo_z]
  sce.joint = cbind(assay(current.sce.seq, "cosineNorm_area"), assay(sce.atlas, "cosineNorm"))
  batchFactor = factor(c(as.character(current.sce.seq$pos), as.character(sce.atlas$sample)))
  
  mapping.embryo_z = lapply(nPC.grid, function(nPC){
    print(nPC)
    mbpca = multiBatchPCA(sce.joint, batch = batchFactor, d = nPC)
    out = do.call(reducedMNN, mbpca)
    joint.pca = out$corrected
    current.knns = queryKNN( joint.pca[colnames(sce.atlas),], joint.pca[colnames(current.sce.seq),], k = n.neigh, 
                           get.index = TRUE, get.distance = FALSE)
    cells.mapped = apply(current.knns$index, 1, function(x) colnames(sce.atlas)[x])
    colnames(cells.mapped) = colnames(current.sce.seq)
    return(cells.mapped)
  })
  names(mapping.embryo_z) = paste0("nPC_", nPC.grid)
  return(mapping.embryo_z)
}, BPPARAM = mcparam )
names(mapping) = embryo_z.grid
#mapping = transpose(mapping)
#for (i in 1:length(mapping)){
#  current.mapping = mapping[[i]]
#  current.mapping = do.call(cbind, current.mapping)
#  mapping[[i]] = current.mapping
#}
saveRDS(mapping, file =  paste0( root.dir, "data/8_5/stitching/mapping_seq2atlas_allGenes_diffPC.rds"))


```
## atlas2atlas

```{r atlas-closest-cell, message=FALSE}

cosine.atlas = assay(sce.atlas, "cosineNorm")
batchFactor = factor(c(as.character(sce.atlas$sample)))

sample.grid = unique(sce.atlas$sample)
mapping = bplapply(sample.grid, function(sample){
  mapping.sample = lapply(nPC.grid, function(nPC){
    print(nPC)
    mbpca = multiBatchPCA(cosine.atlas, batch = batchFactor, d = nPC)
    out = do.call(reducedMNN, mbpca)
    atlas.pca = out$corrected
    current.knns = queryKNN( atlas.pca[colnames(sce.atlas) %in% colnames(sce.atlas[, sce.atlas$sample == sample]),], 
                             atlas.pca[!colnames(sce.atlas) %in% colnames(sce.atlas[, sce.atlas$sample == sample]),], k = n.neigh, 
                           get.index = TRUE, get.distance = FALSE)
    cells.mapped = apply(current.knns$index, 1, function(x) colnames(sce.atlas)[x])
    colnames(cells.mapped) = colnames(current.sce.seq)
    return(cells.mapped)
  })
  names(mapping.sample) = paste0("nPC_", nPC.grid)
  return(mapping.sample)
}, BPPARAM = mcparam )
names(mapping) = sample.grid
#mapping = transpose(mapping)
#for (i in 1:length(mapping)){
#  current.mapping = mapping[[i]]
#  current.mapping = do.call(cbind, current.mapping)
#  mapping[[i]] = current.mapping
#}
saveRDS(mapping, file =  paste0( root.dir, "data/8_5/stitching/mapping_atlas2atlas_allGenes_diffPC.rds"))


```


#Session Info

```{r sessinf}

sessionInfo()

```
