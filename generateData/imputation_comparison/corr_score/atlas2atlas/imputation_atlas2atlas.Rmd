---
title: "Pipeline to impute atlas onto spatial embryo."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: true
    theme: united
---

Options:

nPC = 100

nn = 25

metric = mean

# Load dependencies and source data

```{r load_data, message=FALSE}

library(Matrix)
library(scran)
library(BiocParallel)
library(BiocNeighbors)
ncores = 15
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
library(igraph)
library(reshape2)
library(knitr)
library(scater)
library(scales)
library(biomaRt)
library(batchelor)
library(irlba)
library(batchelor)
library(tibble)
library(dplyr)

#root.dir = "/Users/alsu/Develop/spatial/mouse_embryo/"
root.dir = "/nfs/research1/marioni/alsu/spatial/mouse_embryo/"
source(paste0(root.dir, "amScripts_mouseEmbryoFISH/core_functions.R"))

load_embryo_8.5(dir = "cluster")
sce.seq = sce[!rownames(sce) == "Xist",]

# add batching w z
sce.seq$embryo_pos_z = paste0(sce.seq$embryo_pos, "_", sce.seq$z)
sce.seq$embryo_z = paste0(sce.seq$embryo, "_", sce.seq$z)
meta$embryo_pos_z = paste0(meta$embryo_pos, "_", meta$z)
meta$embryo_z = paste0(meta$embryo, "_", meta$z)

# load atlas 
sce.atlas = readRDS(paste0(root.dir, "data/reducedAtlas/E8_25__E8_5.rds"))
sce.atlas = sce.atlas[rownames(sce.seq), ]
sce.atlas <- computeSumFactors(sce.atlas)
sce.atlas <- scater::normalize(sce.atlas)
assay(sce.atlas, "cosineNorm") <- cosineNorm(logcounts(sce.atlas))
meta.atlas = colData(sce.atlas)

sce.cosine = assay(sce.atlas, "cosineNorm")
batchFactor = factor(c(as.character(sce.atlas$sample)))


```

# Map onto atlas

```{r map-atlas, message=FALSE}

n.neigh = 25
nPC = 100
genes = rownames(sce.seq)

stat.corr.atlas2atlas = bplapply(genes, function(current.gene){
  current.sce.cosine = sce.cosine[!rownames(sce.cosine) == current.gene, ]
  mbpca = multiBatchPCA(current.sce.cosine, batch = batchFactor, d = nPC)
  out = do.call(reducedMNN, mbpca)
  atlas.pca = out$corrected
  current.knns = queryKNN( atlas.pca, atlas.pca, k = ( n.neigh + 1) , 
                           get.index = TRUE, get.distance = TRUE)
  cells.mapped = t(apply(current.knns$index, 1, function(x) colnames(sce.atlas)[x]))
  current.mapping = lapply(1:dim(sce.cosine)[2], function(x){
    out = list(cells.mapped = cells.mapped[x,2:(n.neigh + 1)])
    return(out)
  })
  names(current.mapping) = colnames(sce.cosine)
  
  # impute
  current.sce.atlas = sce.atlas[rownames(sce.atlas) == current.gene, ]
  current.counts.atlas = data.frame(cell = colnames(current.sce.atlas), logcounts.real = as.numeric(  logcounts(current.sce.atlas) ))
  
  estimated.counts.mean.per_nn = sapply(current.mapping, function(x){
    cells = x$cells.mapped
    cells = cells[1:n.neigh]
    out = mean( current.counts.atlas$logcounts.real[current.counts.atlas$cell %in% cells])
    return(out) 
  })
  estimated.counts.mean.per_nn = data.frame(cell = names(estimated.counts.mean.per_nn), logcounts.imputed = estimated.counts.mean.per_nn)
  estimated.counts.mean.per_nn = merge(estimated.counts.mean.per_nn, meta.atlas, all.x = T)
  estimated.counts.mean.per_nn =  merge(estimated.counts.mean.per_nn, current.counts.atlas, all.x = T)
    
  
  # get correlation stat
  # calc correlations: all cells + per CTs
  
  # all
  stat.all = data.frame(gene = current.gene, corr.all = cor(estimated.counts.mean.per_nn$logcounts.real, 
                                                            estimated.counts.mean.per_nn$logcounts.imputed, 
                                                            method = "pearson"))
  
  # per CT
  unq.CT = unique(meta.atlas$celltype)
  stat.perCT = sapply(unq.CT, function(i.CT){
    current.df = estimated.counts.mean.per_nn[estimated.counts.mean.per_nn$celltype == i.CT,]
    
    out = data.frame(mean = mean(current.df$logcounts.real), 
                     corr = cor(current.df$logcounts.real, current.df$logcounts.imputed, method = "pearson"))
    return(out)
  })
  
  # merge
  stat = list(stat.all = stat.all, stat.perCT = stat.perCT)
  return(stat)
}, BPPARAM = mcparam)
names(stat.corr.atlas2atlas) = genes
saveRDS(stat.corr.atlas2atlas, file =  paste0( root.dir, "data/8_5/stitching/stat_corr_atlas2atlas.rds"))


```

#Session Info

```{r sessinf}

sessionInfo()

```
