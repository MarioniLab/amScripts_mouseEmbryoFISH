---
title: "Pipeline to compare imputations of the atlas."
output:
  BiocStyle::html_document:
    code_folding: hide
    number_sections: yes
    toc: yes  
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: true
    theme: united
---

Options:

nPC = 25, 50, 100

nn = c(1, 5:5:50) 

metrics: mean, median, Q25, Q75, weighted mean

# Load dependencies and source data

```{r load_data, message=FALSE}

library(Matrix)
library(scran)
library(BiocParallel)
library(BiocNeighbors)
ncores = 3
mcparam = MulticoreParam(workers = ncores)
register(mcparam)
library(igraph)
library(reshape2)
library(knitr)
library(scater)
library(scales)
library(biomaRt)
library(batchelor)
library(irlba)
library(batchelor)

#root.dir = "/Users/alsu/Develop/spatial/mouse_embryo/"
root.dir = "/nfs/research1/marioni/alsu/spatial/mouse_embryo/"
source(paste0(root.dir, "amScripts_mouseEmbryoFISH/core_functions.R"))

load_embryo_8.5(dir = "cluster", version = "old_filtered")
#load_embryo_8.5(dir = "local", version = "old_filtered")
sce.seq = sce[!rownames(sce) == "Xist",]

# load atlas 
sce.atlas = readRDS(paste0(root.dir, "data/reducedAtlas/E8_25__E8_5.rds"))
#rowData(sce.atlas)[rowData(sce.atlas)[,"SYMBOL"] == "Prkcdbp", "SYMBOL"] <- "Cavin3"
#rowData(sce.atlas)[rowData(sce.atlas)[,"SymbolUniq"] == "Prkcdbp", "SymbolUniq"] <- "Cavin3"
#rownames(sce.atlas) <- rowData(sce.atlas)$SymbolUniq
sce.atlas = sce.atlas[rownames(sce.seq), ]
sce.atlas <- computeSumFactors(sce.atlas)
sce.atlas <- scater::normalize(sce.atlas)
assay(sce.atlas, "cosineNorm") <- cosineNorm(logcounts(sce.atlas))

# seq and atlas
sce.seq = sce.seq[,order(colnames(sce.seq))]
sce.atlas = sce.atlas[,order(colnames(sce.atlas))]

# join them together
sce.seq$embryo_pos = paste0(sce.seq$embryo, "_", sce.seq$pos)
sce.joint = cbind(assay(sce.seq, "cosineNorm"), assay(sce.atlas, "cosineNorm"))
batchFactor = factor(c(as.character(sce.seq$embryo_pos), as.character(sce.atlas$sample)))


```

# Map onto atlas

```{r map-atlas, message=FALSE}

nPC = c(25, 50, 100)
knns = lapply(nPC, function(x){
  mbpca = multiBatchPCA(sce.joint, batch = batchFactor, d = x)
  out = do.call(reducedMNN, mbpca)
  joint.pca = out$corrected
  current.knns = queryKNN( joint.pca[colnames(sce.atlas),], joint.pca[colnames(sce.seq),], k = 50, 
                           get.index = TRUE, get.distance = TRUE, BPPARAM = mcparam)
  return(current.knns) 
})

# get ids, celltypes and distances for 50 closest cells
mapping = lapply(c(1:length(nPC)), function(y){
  cells.mapped = t(apply(knns[[y]]$index, 1, function(x) colnames(sce.atlas)[x]))
  distances.mapped = t(apply(knns[[y]]$distance, 1, function(x) colnames(sce.atlas)[x])) 
  celltypes.mapped = t(apply(cells.mapped, 1, function(x) sce.atlas$celltype[match(x, colnames(sce.atlas))]))
  
  current.mapping = lapply(1:dim(sce.seq)[2], function(x){
    out = list(cells.mapped = cells.mapped[x,],
               celltypes.mapped = celltypes.mapped[x,],
               distances.mapped = distances.mapped[x,])
    return(out)
  })
  names(current.mapping) = colnames(sce.seq)
  return(current.mapping)
})
names(mapping) = paste0("PC_", nPC)
saveRDS(mapping, file = paste0( root.dir, "data/8_5/mapping_to_atlas.rds"))


```

# Estimate imputed data

To calibrate stitching (nn and metric we use), we will only calculate stitching on seq+sm genes

## Prepare data

```{r prepare-atlas-for-imputation, message=FALSE}

n.neigh = seq(5,50,by = 5)
genes = read.table(paste0( root.dir, "data/geneInfo/stat.tab"), stringsAsFactors = F, header = T)
genes = genes$external_gene_name
sce.atlas = sce.atlas[rownames(sce.atlas) %in% genes, ]
counts.atlas = logcounts(sce.atlas)

```

## Mean 

```{r imputed-mean, message=FALSE}

getCounts = function(cells){
  current.counts = counts.atlas[,colnames(counts.atlas) %in% cells]
  current.counts = apply( current.counts , 1, mean)
  return(current.counts)
}

estimated.counts = lapply(1:length(mapping), function(y){
  estimated.counts.per_nPC = lapply(n.neigh, function(current.n){
    estimated.counts.per_nPC.per_nn = bplapply(mapping[[y]], function(x){
      cells = x$cells.mapped
      cells = cells[1:current.n]
      return(getCounts(cells)) 
    }, BPPARAM = mcparam)
    estimated.counts.per_nPC.per_nn = do.call(cbind, estimated.counts.per_nPC.per_nn)
    colnames(estimated.counts.per_nPC.per_nn) = names(mapping[[y]])
    rownames(estimated.counts.per_nPC.per_nn) = rownames(counts.atlas)
    saveRDS(estimated.counts.per_nPC.per_nn, 
            file =  paste0( root.dir, "data/8_5/stitching/compareMetrics/nn_", current.n, "__nPC_", names(mapping)[y], "__mean.rds"))
  })
})

```

## Median 

```{r imputed-median, message=FALSE}

getCounts = function(cells){
  current.counts = counts.atlas[,colnames(counts.atlas) %in% cells]
  current.counts = apply( current.counts , 1, median)
  return(current.counts)
}

estimated.counts = lapply(1:length(mapping), function(y){
  estimated.counts.per_nPC = lapply(n.neigh, function(current.n){
    estimated.counts.per_nPC.per_nn = bplapply(mapping[[y]], function(x){
      cells = x$cells.mapped
      cells = cells[1:current.n]
      return(getCounts(cells)) 
    }, BPPARAM = mcparam)
    estimated.counts.per_nPC.per_nn = do.call(cbind, estimated.counts.per_nPC.per_nn)
    colnames(estimated.counts.per_nPC.per_nn) = names(mapping[[y]])
    rownames(estimated.counts.per_nPC.per_nn) = rownames(counts.atlas)
    saveRDS(estimated.counts.per_nPC.per_nn, 
            file =  paste0( root.dir, "data/8_5/stitching/compareMetrics/nn_", current.n, "__nPC_", names(mapping)[y], "__median.rds"))
  })
})

```

## Q25 

```{r imputed-q25, message=FALSE}

getCounts = function(cells){
  current.counts = counts.atlas[,colnames(counts.atlas) %in% cells]
  current.counts = apply( current.counts , 1, function(x) quantile(x, .25))
  return(current.counts)
}

estimated.counts = lapply(1:length(mapping), function(y){
  estimated.counts.per_nPC = lapply(n.neigh, function(current.n){
    estimated.counts.per_nPC.per_nn = bplapply(mapping[[y]], function(x){
      cells = x$cells.mapped
      cells = cells[1:current.n]
      return(getCounts(cells)) 
    }, BPPARAM = mcparam)
    estimated.counts.per_nPC.per_nn = do.call(cbind, estimated.counts.per_nPC.per_nn)
    colnames(estimated.counts.per_nPC.per_nn) = names(mapping[[y]])
    rownames(estimated.counts.per_nPC.per_nn) = rownames(counts.atlas)
    saveRDS(estimated.counts.per_nPC.per_nn, 
            file =  paste0( root.dir, "data/8_5/stitching/compareMetrics/nn_", current.n, "__nPC_", names(mapping)[y], "__q25.rds"))
  })
})

```

## Q75 

```{r imputed-q75, message=FALSE}

getCounts = function(cells){
  current.counts = counts.atlas[,colnames(counts.atlas) %in% cells]
  current.counts = apply( current.counts , 1, function(x) quantile(x, .75))
  return(current.counts)
}

estimated.counts = lapply(1:length(mapping), function(y){
  estimated.counts.per_nPC = lapply(n.neigh, function(current.n){
    estimated.counts.per_nPC.per_nn = bplapply(mapping[[y]], function(x){
      cells = x$cells.mapped
      cells = cells[1:current.n]
      return(getCounts(cells)) 
    }, BPPARAM = mcparam)
    estimated.counts.per_nPC.per_nn = do.call(cbind, estimated.counts.per_nPC.per_nn)
    colnames(estimated.counts.per_nPC.per_nn) = names(mapping[[y]])
    rownames(estimated.counts.per_nPC.per_nn) = rownames(counts.atlas)
    saveRDS(estimated.counts.per_nPC.per_nn, 
            file =  paste0( root.dir, "data/8_5/stitching/compareMetrics/nn_", current.n, "__nPC_", names(mapping)[y], "__q75.rds"))
  })
})

```

## Weighted mean

```{r imputed-weight-mean, message=FALSE}

getCounts = function(cells, distances.weight){
  current.counts = counts.atlas[,colnames(counts.atlas) %in% cells]
  current.counts = current.counts %*% distances.weight
  return(current.counts)
}

estimated.counts = lapply(1:length(mapping), function(y){
  estimated.counts.per_nPC = lapply(n.neigh, function(current.n){
    estimated.counts.per_nPC.per_nn = bplapply(mapping[[y]], function(x){
      distances.weight = x$distances.mapped
      distances.weight = 1 / distances.weight[1:current.n]
      distances.weight = distances.weight/sum(distances.weight)
      cells = x$cells.mapped
      cells = cells[1:current.n]
      return(getCounts(cells, distances.weight)) 
    }, BPPARAM = mcparam)
    estimated.counts.per_nPC.per_nn = do.call(cbind, estimated.counts.per_nPC.per_nn)
    colnames(estimated.counts.per_nPC.per_nn) = names(mapping[[y]])
    rownames(estimated.counts.per_nPC.per_nn) = rownames(counts.atlas)
    saveRDS(estimated.counts.per_nPC.per_nn, 
            file =  paste0( root.dir, "data/8_5/stitching/compareMetrics/nn_", current.n, "__nPC_", names(mapping)[y], "__weightedMean.rds"))
  })
})

```



#Session Info

```{r sessinf}
sessionInfo()
```
